---
sidebar_position: 4
---

# Supabase DDL     

- [Supabase DDL](#supabase-ddl)
  - [Basic](#basic)
    - [üìå Datatype](#-datatype)
    - [üìå Ïª¨Îüº ÏÑ§Ï†ï](#-Ïª¨Îüº-ÏÑ§Ï†ï)
    - [Snippets](#snippets)
  - [üìå Todo Table DDL (without RLS)](#-todo-table-ddl-without-rls)
  - [üìå Todo Table DML (without RLS)](#-todo-table-dml-without-rls)
    - [REST API](#rest-api)
    - [Ï∞∏Í≥†) Îã§Î•∏ Ïä§ÌÇ§Îßà Ï°∞ÌöåÌïòÎäî Î≤ï](#Ï∞∏Í≥†-Îã§Î•∏-Ïä§ÌÇ§Îßà-Ï°∞ÌöåÌïòÎäî-Î≤ï)
  - [Todos with RLS (in editor)](#todos-with-rls-in-editor)
    - [DDL with editor](#ddl-with-editor)


## Basic  

### üìå Datatype    

- boolean
- integer = int4 / bigint = int8 / numeric -- ÏûêÎèô / numeric(5, 2) -- ÏµúÎåÄ 5ÏûêÎ¶¨ Ïà´Ïûê, ÏÜåÏàòÏ†ê Ïù¥Ìïò 2ÏûêÎ¶¨  
- varchar(32), text  
- uuid
- timestamp with time zone  
- json, jsonb
Ref : https://supabase.com/docs/guides/database/tables?queryGroups=database-method&database-method=sql&queryGroups=language&language=js#data-types    

```sql
  "isNotified" boolean
  "id" integer
  "id" bigint
  "price" numeric
  "title" VARCHAR(255)
  "website" text
  "id" uuid
  "updated_at" timestamp with time zone
	"content" json 
  "content" jsonb 
```

### üìå Ïª¨Îüº ÏÑ§Ï†ï 
- PK, FK, CONSTRAINT  
- generated by default as identity
- DEFAULT false | gen_random_uuid() | now()
- NOT NULL
- UNIQUE  

```sql
CREATE TABLE IF NOT EXISTS ai_chat_test.chat (...);

-- PK, FK Inilne  
  "id" bigint generated by default as identity primary key -- primary key Î•º Î™ÖÏãú 
  "userId" uuid NOT NULL references "public"("id") -- REFERENCES Î∂ÄÎ™®_ÌÖåÏù¥Î∏î(id) 

-- PK, FK, CONSTRAINT (with table)  
  "id" bigint generated by default as identity NOT NULL,
  CONSTRAINT "gpts_quration_id_pk" PRIMARY KEY("id") -- PRIMARY KEY (id)  

  "id" uuid DEFAULT gen_random_uuid() NOT NULL,
	CONSTRAINT "suggestion_id_pk" PRIMARY KEY("id") -- PRIMARY KEY (id)  

  "userId" uuid NOT NULL 
  CONSTRAINT "chat_userId_profile_id_fk" FOREIGN KEY ("userId") REFERENCES "profiles"("id") -- FOREIGN KEY (fk_id) REFERENCES Î∂ÄÎ™®_ÌÖåÏù¥Î∏î(id)

-- PK, FK, CONSTRAINT (ÏàòÏ†ïÌïÑÏöîÏãú)  
ALTER TABLE public.chat
  ADD CONSTRAINT "chat_userId_profiles_id_fk"
  FOREIGN KEY ("userId") 
  REFERENCES public.profiles(id) 
  ON DELETE NO ACTION ON UPDATE NO ACTION;

-- generated by default as identity
  "logId" uuid DEFAULT gen_random_uuid() NOT NULL

-- DEFAULT false | gen_random_uuid() | now()
  "isResolved" boolean DEFAULT false
	"id" uuid DEFAULT gen_random_uuid()
	"createdAt" timestamp with time zone DEFAULT now() NOT NULL,

-- NOT NULL
  "userId" uuid NOT NULL
	"documentCreatedAt" timestamp with time zone NOT NULL,
	"createdAt" timestamp with time zone DEFAULT now() NOT NULL,
	"updatedAt" timestamp with time zone DEFAULT now() NOT NULL,
	"deletedAt" timestamp with time zone NULL

-- UNIQUE  
  "username" text unique
```

### Snippets

```sql
-- bigint pk 
	"id" bigint generated by default as identity NOT NULL,
	CONSTRAINT "gpts_quration_id_pk" PRIMARY KEY("id")

-- uuid pk
	"id" uuid DEFAULT gen_random_uuid() NOT NULL,
	CONSTRAINT "suggestion_id_pk" PRIMARY KEY("id")

-- PL/pgSQL Block fk
DO $$ BEGIN
    ALTER TABLE public.chat
    ADD CONSTRAINT "chat_userId_profiles_id_fk"
    FOREIGN KEY ("userId") REFERENCES public.profiles(id) ON DELETE NO ACTION ON UPDATE NO ACTION;
EXCEPTION
    WHEN duplicate_object THEN NULL;
END $$; 

-- timestamps
	"createdAt" timestamp with time zone DEFAULT now() NOT NULL,
	"updatedAt" timestamp with time zone DEFAULT now() NOT NULL,
	"deletedAt" timestamp with time zone NULL
```

## üìå Todo Table DDL (without RLS)    

```Sql
CREATE TABLE todos (
    id uuid DEFAULT gen_random_uuid(),  -- UUIDÎ°ú Í≥†Ïú† ÏãùÎ≥ÑÏûê
    -- id uuid PRIMARY KEY DEFAULT gen_random_uuid()
    user_id uuid NOT NULL,  -- ÏÇ¨Ïö©Ïûê ID (ÌïÑÏàò)
    -- user_id uuid REFERENCES auth.users(id) NOT NULL
    title varchar(32) NOT NULL UNIQUE,  -- Ìï† Ïùº Ï†úÎ™© (Í≥†Ïú†, ÌïÑÏàò)
    description text,  -- Ìï† Ïùº ÏÑ§Î™Ö (ÏÑ†ÌÉùÏ†Å)
    is_completed boolean DEFAULT false,  -- ÏôÑÎ£å Ïó¨Î∂Ä (Í∏∞Î≥∏Í∞í false)
    priority integer CHECK (priority >= 1 AND priority <= 5),  -- Ïö∞ÏÑ†ÏàúÏúÑ (1~5)
    due_date timestamp with time zone,  -- ÎßàÍ∞êÏùº
    created_at timestamp with time zone DEFAULT now(),  -- ÏÉùÏÑ± ÏãúÍ∞Ñ
    updated_at timestamp with time zone DEFAULT now(),  -- ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÍ∞Ñ
    metadata jsonb,  -- Ï∂îÍ∞Ä Î©îÌÉÄÎç∞Ïù¥ÌÑ∞
    CONSTRAINT todos_pkey PRIMARY KEY (id),  -- Í∏∞Î≥∏ ÌÇ§ Ï†úÏïΩ Ï°∞Í±¥
    CONSTRAINT todos_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)  -- Ïô∏Îûò ÌÇ§ Ï†úÏïΩ Ï°∞Í±¥
);
---
CREATE TABLE todos (
    id uuid DEFAULT gen_random_uuid(),  
    title varchar(32) NOT NULL,  
    description text,  
    is_completed boolean DEFAULT false,  
    created_at timestamp with time zone DEFAULT now(),  
    updated_at timestamp with time zone DEFAULT now(),  
    CONSTRAINT todos_pkey PRIMARY KEY (id),  
);
```

## üìå Todo Table DML (without RLS)    

```
[READ]
select * from public."todos";

-- idÎ•º ÎÇ¥Î¶ºÏ∞® ÏàúÏúºÎ°ú public."todos" Ï°∞Ìöå Ìï¥Ï§ò
select  * from public."todos" order by id desc;

-- public."todos" ÏóêÏÑú deleted_atÏù¥ null Ïù∏Í≤ÉÎßå Î™®Îëê Ï°∞ÌöåÌï¥
select  * from  public."todos" where  deleted_at is null;

-- Îπ®ÎûòÎùºÎäî Îã®Ïñ¥Í∞Ä Ìè¨Ìï®ÎêòÎäî Ï°∞Í±¥ÏùÑ Ï∂îÍ∞ÄÌï¥Ï§ò  
select * from  public."todos" where  deleted_at is null and title like '%Îπ®Îûò%';

[CREATE]
insert into  public."todos" (title) values  ('Îπ®ÎûòÎ•º ÏÑ∏ÌÉÅÌïòÍ∏∞');

[UPDATE]
-- title Í∞íÏùÑ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÎäî sql Íµ¨Î¨∏ ÎßåÎì§Ïñ¥Ï§ò
update public."todos" set title = 'Ïã†Î∞ú ÏÑ∏ÌÉÅ 2' where  id = 5;

-- updated_at ÏùÑ ÌòÑÏû¨ÏãúÍ∞ÑÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏ ÌïòÎäî update Íµ¨Î¨∏ ÎßåÎì§Ïñ¥Ï§ò
update public."todos" set  title = 'Ïã†Î∞ú ÏÑ∏ÌÉÅ 2', updated_at = current_timestamp where  id = 5;

[Delete]
-- ÌäπÏ†ï ÌñâÏùÑ ÏßÄÏö∞Îäî Íµ¨Î¨∏ ÎßåÎì§Ïñ¥Ï§ò
delete from public."todos" where id = 5;
```

### REST API

![Alt text](image-6.png)

Check API Docs

```js
Read all rows
curl 'https://YOURS.supabase.co/rest/v1/todos?select=*' \
-H "apikey: SUPABASE_KEY"

Read specific columns
curl 'https://YOURS.supabase.co/rest/v1/todos?select=some_column,other_column' \
-H "apikey: SUPABASE_KEY"

Read referenced tables
curl 'https://YOURS.supabase.co/rest/v1/todos?select=some_column,other_table(foreign_key)' \
-H "apikey: SUPABASE_KEY"

With pagination
curl 'https://YOURS.supabase.co/rest/v1/todos?select=*' \
-H "apikey: SUPABASE_KEY" \
-H "Range: 0-9"

With filtering
curl 'https://YOURS.supabase.co/rest/v1/todos?id=eq.1&select=*' \
-H "apikey: SUPABASE_KEY" \
-H "Range: 0-9"
```

### Ï∞∏Í≥†) Îã§Î•∏ Ïä§ÌÇ§Îßà Ï°∞ÌöåÌïòÎäî Î≤ï    

Ref : https://supabase.com/docs/guides/api/using-custom-schemas

```
1.
Settings > Exposed schemasÏóê ÎÖ∏Ï∂úÌï†  Ï∂îÍ∞ÄÌïòÍ∏∞

---
2.
GRANT USAGE ON SCHEMA myschema TO anon, authenticated, service_role;
GRANT ALL ON ALL TABLES IN SCHEMA myschema TO anon, authenticated, service_role;
GRANT ALL ON ALL ROUTINES IN SCHEMA myschema TO anon, authenticated, service_role;
GRANT ALL ON ALL SEQUENCES IN SCHEMA myschema TO anon, authenticated, service_role;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA myschema GRANT ALL ON TABLES TO anon, authenticated, service_role;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA myschema GRANT ALL ON ROUTINES TO anon, authenticated, service_role;
ALTER DEFAULT PRIVILEGES FOR ROLE postgres IN SCHEMA myschema GRANT ALL ON SEQUENCES TO anon, authenticated, service_role;

---
3.
curl --location 'https://ID.supabase.co/rest/v1/todos?select=*' \
--header 'apikey: KEY' \
--header 'Accept-Profile: ai_chat_test'

---
4.
// Initialize the JS client
import { createClient } from '@supabase/supabase-js'
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { db: { schema: 'myschema' } })

// Make a request
const { data: todos, error } = await supabase.from('todos').select('*')

// You can also change the target schema on a per-query basis
const { data: todos, error } = await supabase.schema('myschema').from('todos').select('*')

``` 

## Todos with RLS (in editor)  

### DDL with editor

![Alt text](image-4.png)


|Add foreign key relation|Foreign Keys|
|------|---|
|![Alt text](./img/image-3.png)  |![Alt text](./img/image-4.png)|
